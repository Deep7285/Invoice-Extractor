<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Invoice Extractor (GPT)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- pdf.js (for PDF → images) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- Mammoth (DOCX → text) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

  <style>
    :root { --pad: 14px; --bg:#0b1020; --fg:#e9eef6; --muted:#96a3b8; --accent:#5cc8ff; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:system-ui, Arial, sans-serif; }
    .wrap { max-width: 880px; margin: 32px auto; padding: 0 var(--pad); }
    h1 { margin:0 0 16px; font-size: 24px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 18px; box-shadow: 0 4px 16px rgba(0,0,0,.25); }
    .row { margin-top: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input[type=file] { color: var(--fg); }
    button { background: var(--accent); color:#001019; border:none; padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .hint { color: var(--muted); font-size: 13px; }
    #status { margin-top: 10px; font-size: 14px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(0,0,0,.25);
           padding:12px; border-radius: 10px; white-space:pre-wrap; max-height: 200px; overflow:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Invoice Extractor </h1>
    <div class="card">
      <div class="row">
        <input id="fileInput" type="file" multiple accept=".pdf,.docx,image/*">
        <button id="runBtn">Extract</button>
      </div>
      <div class="row hint">
        • PDF pages are limited to 10 per file • JPG/PNG supported • DOCX text is extracted client-side
      </div>
      <div id="status" class="row"></div>
      <div id="log" class="log" hidden></div>
    </div>
  </div>

  <script type="module">
    // ───────────────── CONFIG ─────────────────
    // During local dev (wrangler dev):
    // const WORKER_ENDPOINT = "http://127.0.0.1:8787";
    // After deploy (replace with your workers.dev URL):
    const WORKER_ENDPOINT = "https://invoice-worker.deepak72855.workers.dev"; // TODO: change after deploy

    const MAX_PAGES = 10;
    const JPEG_QUALITY = 0.7;
    const TARGET_WIDTH = 1300;

    const fileInput = document.getElementById("fileInput");
    const runBtn = document.getElementById("runBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    function log(msg) {
      logEl.hidden = false;
      logEl.textContent += msg + "\\n";
    }
    function setStatus(msg) { statusEl.textContent = msg; }

    async function fileToDataUrl(file) {
      return new Promise((resolve) => {
        const r = new FileReader();
        r.onload = e => resolve(e.target.result);
        r.readAsDataURL(file);
      });
    }

    async function pdfToImages(file) {
      const dataUrl = await fileToDataUrl(file);
      const pdf = await pdfjsLib.getDocument({ url: dataUrl }).promise;
      const pages = Math.min(pdf.numPages, MAX_PAGES);
      const out = [];
      for (let p = 1; p <= pages; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 1.5 });
        const scale = TARGET_WIDTH / viewport.width;
        const vp = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = Math.floor(vp.width);
        canvas.height = Math.floor(vp.height);
        await page.render({ canvasContext: ctx, viewport: vp }).promise;
        const jpeg = canvas.toDataURL("image/jpeg", JPEG_QUALITY);
        out.push(jpeg);
      }
      return out;
    }

    async function imageToCompressedDataUrl(file) {
      const dataUrl = await fileToDataUrl(file);
      const img = new Image();
      await new Promise(res => { img.onload = res; img.src = dataUrl; });
      const scale = img.width > TARGET_WIDTH ? TARGET_WIDTH / img.width : 1;
      const canvas = document.createElement("canvas");
      canvas.width = Math.floor(img.width * scale);
      canvas.height = Math.floor(img.height * scale);
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/jpeg", JPEG_QUALITY);
    }

    async function docxToText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({ arrayBuffer });
      return result.value || "";
    }

    async function postToWorker({ imagesDataUrls = [], docText = "" }) {
      const form = new FormData();
      for (const d of imagesDataUrls) form.append("images_dataurl[]", d);
      if (docText && docText.trim()) form.append("doc_text", docText.trim());
      const resp = await fetch(\`\${WORKER_ENDPOINT}/api/extract\`, { method: "POST", body: form });
      if (!resp.ok) throw new Error(await resp.text() || \`HTTP \${resp.status}\`);
      return resp.json();
    }

    function rowFromJson(json, source) {
      const seller = json?.seller ?? {};
      const invoice = json?.invoice ?? {};
      const amounts = json?.amounts ?? {};
      const taxes = Array.isArray(json?.taxes) ? json.taxes : [];
      const taxStr = taxes.map(t => \`\${t.type} \${t.rate_percent ?? "null"}%:\${t.amount ?? "null"}\`).join("; ");
      return {
        SELLER_NAME: seller.company_name ?? null,
        SELLER_GSTIN: seller.gstin ?? null,
        SELLER_ADDRESS: seller.address ?? null,
        INVOICE_NUMBER: invoice.number ?? null,
        INVOICE_DATE: invoice.date ?? null,
        TRANSACTION_ID: invoice.transaction_id ?? null,
        TAXABLE_AMOUNT: amounts.taxable_amount ?? null,
        TOTAL_AMOUNT: amounts.total_amount ?? null,
        TAX_BREAKDOWN: taxStr || null,
        SOURCE_FILE: source ?? null
      };
    }

    function downloadExcel(rows, filename = "invoices_gpt.xlsx") {
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Invoices");
      XLSX.writeFile(wb, filename);
    }

    runBtn.addEventListener("click", async () => {
      try {
        runBtn.disabled = true;
        logEl.textContent = ""; logEl.hidden = true;
        setStatus("Processing…");
        const files = Array.from(fileInput.files || []);
        if (!files.length) throw new Error("Select at least one file");

        const rows = [];
        for (const f of files) {
          setStatus(\`Processing \${f.name}…\`);
          log(\`→ \${f.name}\`);
          let payload = { imagesDataUrls: [], docText: "" };

          if (f.type === "application/pdf") {
            payload.imagesDataUrls = await pdfToImages(f);
            log(\`   PDF pages → \${payload.imagesDataUrls.length} image(s)\`);
          } else if (f.type.startsWith("image/")) {
            payload.imagesDataUrls = [await imageToCompressedDataUrl(f)];
            log("   Image compressed");
          } else if (f.name.toLowerCase().endsWith(".docx")) {
            payload.docText = await docxToText(f);
            log("   DOCX text extracted");
          } else {
            log(\`   Skipped unsupported file: \${f.name}\`);
            continue;
          }

          const json = await postToWorker(payload);
          rows.push(rowFromJson(json, f.name));
          log("   ✓ extracted");
        }

        if (rows.length) {
          downloadExcel(rows);
          setStatus("Done. Excel downloaded.");
        } else {
          setStatus("No supported files processed.");
        }
      } catch (e) {
        console.error(e);
        setStatus(\`Error: \${e.message}\`);
        log(\`Error: \${e.message}\`);
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
