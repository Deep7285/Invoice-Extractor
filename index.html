<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Extractor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- pdf.js (PDF -> images) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  </script>

  <!-- Mammoth (DOCX -> text) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- SheetJS multi-CDN loader (Excel). We wait for it only when user clicks Download. -->
  <script>
    (function loadSheetJS(){
      const urls = [
        "https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js",
        "https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js"
      ];
      let i = 0;
      function next(){
        if (typeof window.XLSX !== "undefined") return;
        if (i >= urls.length) return;
        const s = document.createElement("script");
        s.src = urls[i++];
        s.async = true;
        s.onerror = next;
        document.head.appendChild(s);
      }
      next();
    })();
    function ensureXLSX(timeoutMs){
      return new Promise((resolve, reject)=>{
        const max = timeoutMs || 5000, t0 = Date.now();
        (function check(){
          if (typeof XLSX !== "undefined") return resolve();
          if (Date.now() - t0 > max) return reject(new Error("Excel library not available"));
          setTimeout(check, 150);
        })();
      });
    }
  </script>

  <style>
    :root{
      --bg:#0b1020; --panel:#11172b; --muted:#97a3b9; --fg:#eaf0f8; --accent:#5cc8ff; --accent-2:#19b784;
      --danger:#ff6b6b; --br:14px; --pad:16px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    /* Layout */
    .container{max-width:1060px;margin:0 auto;padding:18px}
    header,footer{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    <img src="assets/logo.png" alt="Logo" class="logo" style="border:none;width:28px;height:28px;border-radius:6px" />
    {width:28px;height:28px;border:2px solid var(--accent);border-radius:6px;display:inline-block}
    nav a{margin-left:16px}

    .hero{display:grid;grid-template-columns:1.1fr 0.9fr;gap:22px;align-items:center;margin-top:24px}
    .heroCard,.card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--br);padding:22px}
    .cta{display:inline-block;background:var(--accent);color:#001018;padding:12px 18px;border-radius:10px;font-weight:700}
    .ghost{display:inline-block;border:1px solid var(--accent);color:var(--fg);padding:11px 16px;border-radius:10px;margin-left:10px}
    .muted{color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none !important}

    /* Extractor view */
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .controls{display:flex;gap:10px;margin-top:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
    .primary{background:var(--accent);color:#001018}
    .success{background:var(--accent-2);color:#001611}
    .outline{background:transparent;border:1px solid var(--accent);color:var(--fg)}
    .danger{background:var(--danger);color:#2b0000}
    .badge{display:inline-block;background:#1b233a;color:#c7d2e6;border:1px solid #2b3552;border-radius:999px;padding:4px 10px;font-size:12px}

    .status{margin-top:10px}
    .log{margin-top:10px;font-family:ui-monospace,Consolas,Menlo,monospace;background:rgba(0,0,0,.22);
         border-radius:12px;padding:12px;white-space:pre-wrap;max-height:220px;overflow:auto}
    .tableWrap{margin-top:14px;overflow:auto;border:1px solid #2b3552;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{position:sticky;top:0;background:#15203b}
    th,td{padding:10px;border-bottom:1px solid #23304e;text-align:left}
    tr:hover td{background:#121a30}

    footer .links{display:flex;gap:14px;align-items:center}
    .icon{width:18px;height:18px;display:inline-block;vertical-align:-3px;margin-right:6px}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header class="container">
    <div class="brand">
      <span class="logo" aria-hidden="true"></span>
      <span>Data Extractor</span>
    </div>
    <nav>
      <a href="#" id="navHome">Home</a>
      <a href="#extract" id="navExtract">Invoice data extraction</a>
      <a class="ghost" href="#" title="Login placeholder">Login</a>
    </nav>
  </header>

  <!-- ===== MAIN ===== -->
  <main>

    <!-- ===== Landing view ===== -->
    <section id="homeView" class="container">
      <div class="hero">
        <div class="heroCard">
          <h1 style="margin:0 0 6px">Extract data from your invoices</h1>
          <p class="muted">Upload PDF / images / DOCX and get a clean Excel file with seller details, GSTIN, invoice number & date, transaction id, taxable & total amounts, and full tax breakdown.</p>
          <div style="margin-top:14px">
            <a class="cta" href="#extract">Go to Invoice data extraction</a>
            <a class="ghost" href="#" id="learnMore">Learn more</a>
          </div>
          <div class="note">Tip: nothing is stored server-side; files are processed in memory and discarded after extraction.</div>
        </div>
        <div class="heroCard center" style="min-height:220px">
          <!-- Placeholder image panel. Replace src with your artwork if you like. -->
          <img src="assets/hero.png" alt="Hero illustration" style="max-width:100%;border-radius:12px" />
        </div>
      </div>
    </section>

    <!-- ===== Extractor view ===== -->
    <section id="extractView" class="container hidden">
      <div class="card">
        <h2 style="margin:0 0 6px">Invoice Extractor</h2>
        <div class="muted" style="margin-bottom:10px">
          Please upload PDF / image (jpg/jpeg/png) / DOCX. One PDF may contain up to <b>10 pages</b>.
        </div>

        <div class="row">
          <input id="fileInput" type="file" multiple accept=".pdf,.docx,image/*" />
          <button id="btnExtract" class="primary">Extract</button>

          <span class="badge" id="badgeCount" title="Rows in current session">0 rows</span>
        </div>

        <div class="controls">
          <button id="btnPreview" class="outline" disabled>Review Excel</button>
          <button id="btnDownload" class="success" disabled>Download Excel</button>
          <button id="btnReset" class="danger" title="Clear current table">Reset session</button>
        </div>

        <div id="status" class="status"></div>
        <div id="log" class="log hidden"></div>

        <div id="previewWrap" class="tableWrap hidden">
          <table id="previewTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="note">Refresh the page to start a new process‚Äîor use ‚ÄúReset session‚Äù.</div>
      </div>
    </section>

  </main>

  <!-- ===== Footer ===== -->
  <footer class="container">
    <div class="muted">¬© <span id="yr"></span> Data Extractor</div>
    <div class="links">
      <a href="mailto:deepak72855@gmail.com"><span class="icon">‚úâÔ∏è</span>deepak72855@gmail.com</a>
      <a href="https://www.linkedin.com/in/deepak8439/" target="_blank" rel="noopener"><span class="icon">üîó</span>LinkedIn</a>
    </div>
  </footer>

  <script>
    // ========= ROUTING (simple two views) =========
    const homeView = document.getElementById('homeView');
    const extractView = document.getElementById('extractView');
    const navHome = document.getElementById('navHome');
    const navExtract = document.getElementById('navExtract');

    function show(view){
      if (view === 'extract'){ homeView.classList.add('hidden'); extractView.classList.remove('hidden'); }
      else { extractView.classList.add('hidden'); homeView.classList.remove('hidden'); }
    }
    function onHash(){ location.hash === '#extract' ? show('extract') : show('home'); }
    window.addEventListener('hashchange', onHash);
    onHash();

    // ========= CONFIG =========
    const WORKER_ENDPOINT = "https://invoice-worker.deepak72855.workers.dev";
    const MAX_PAGES = 10, JPEG_QUALITY = 0.7, TARGET_WIDTH = 1300;

    // ========= DOM refs =========
    const input = document.getElementById('fileInput');
    const btnExtract = document.getElementById('btnExtract');
    const btnPreview = document.getElementById('btnPreview');
    const btnDownload = document.getElementById('btnDownload');
    const btnReset = document.getElementById('btnReset');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const badge = document.getElementById('badgeCount');
    const previewWrap = document.getElementById('previewWrap');
    const table = document.getElementById('previewTable');

    document.getElementById('yr').textContent = new Date().getFullYear();

    function setStatus(html){ statusEl.innerHTML = html; }
    function log(line){
      logEl.classList.remove('hidden');
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setRowCount(n){ badge.textContent = n + " row" + (n===1?"":"s"); }

    // ========= Utilities =========
    function fileToDataURL(file){
      return new Promise(res=>{
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.readAsDataURL(file);
      });
    }

    async function pdfToImages(file){
      const dataUrl = await fileToDataURL(file);
      const pdf = await pdfjsLib.getDocument({ url: dataUrl }).promise;
      const pages = Math.min(pdf.numPages, MAX_PAGES);
      if (pdf.numPages > MAX_PAGES){
        log("   ! Skipping pages after " + MAX_PAGES + " in " + file.name);
      }
      const out = [];
      for (let p=1;p<=pages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 1.5 });
        const scale = TARGET_WIDTH / viewport.width;
        const vp = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(vp.width); canvas.height = Math.floor(vp.height);
        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
        out.push(canvas.toDataURL('image/jpeg', JPEG_QUALITY));
      }
      return out;
    }

    async function imageToCompressedDataUrl(file){
      const dataUrl = await fileToDataURL(file);
      const img = new Image();
      await new Promise(r => { img.onload = r; img.src = dataUrl; });
      const scale = img.width > TARGET_WIDTH ? TARGET_WIDTH / img.width : 1;
      const canvas = document.createElement('canvas');
      canvas.width = Math.floor(img.width * scale);
      canvas.height = Math.floor(img.height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', JPEG_QUALITY);
    }

    async function docxToText(file){
      const ab = await file.arrayBuffer();
      const res = await window.mammoth.extractRawText({ arrayBuffer: ab });
      return res.value || "";
    }

    async function postToWorker(payload){
      const form = new FormData();
      if (payload.imagesDataUrls) payload.imagesDataUrls.forEach(d => form.append("images_dataurl[]", d));
      if (payload.docText) form.append("doc_text", payload.docText);
      const resp = await fetch(WORKER_ENDPOINT + "/api/extract", { method:"POST", body: form });
      if (!resp.ok){
        let t=""; try{ t = await resp.text(); }catch{}
        throw new Error("Worker " + resp.status + ": " + t);
      }
      return resp.json();
    }

    function rowFromJson(json, src){
      const s = json?.seller || {};
      const i = json?.invoice || {};
      const a = json?.amounts || {};
      const taxes = Array.isArray(json?.taxes) ? json.taxes : [];
      const pieces = taxes.map(t => `${t.type||"TAX"} ${t.rate_percent ?? "null"}%:${t.amount ?? "null"}`);
      return {
        SELLER_NAME: s.company_name || null,
        SELLER_GSTIN: s.gstin || null,
        SELLER_ADDRESS: s.address || null,
        INVOICE_NUMBER: i.number || null,
        INVOICE_DATE: i.date || null,
        TRANSACTION_ID: i.transaction_id || null,
        TAXABLE_AMOUNT: a.taxable_amount ?? null,
        TOTAL_AMOUNT: a.total_amount ?? null,
        TAX_BREAKDOWN: pieces.length ? pieces.join("; ") : null,
        SOURCE_FILE: src || null
      };
    }

    // ========= Session state =========
    const sessionRows = [];      // stays until refresh or Reset
    function refreshPreview(){
      if (!sessionRows.length){ previewWrap.classList.add('hidden'); return; }
      // Build <table>
      const cols = Object.keys(sessionRows[0]);
      table.tHead.innerHTML = "<tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr>";
      table.tBodies[0].innerHTML = sessionRows.map(r=>(
        "<tr>"+cols.map(c=>`<td>${(r[c] ?? "")}</td>`).join("")+"</tr>"
      )).join("");
      previewWrap.classList.remove('hidden');
      setRowCount(sessionRows.length);
      btnPreview.disabled = false;
      btnDownload.disabled = false;
    }

    function downloadCsv(rows, filename){
      if (!rows.length) return;
      const headers = Object.keys(rows[0]);
      const csv = [headers.join(",")]
        .concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? "")).join(",")))
        .join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    async function downloadExcel(rows){
      try{
        await ensureXLSX();
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Invoices");
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
        XLSX.writeFile(wb, "invoices_"+stamp+".xlsx");
      } catch(e){
        // Silent fallback to CSV; we keep the UI clean as requested
        console.warn("Excel lib not available, falling back to CSV:", e?.message);
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
        downloadCsv(rows, "invoices_"+stamp+".csv");
      }
    }

    // ========= Actions =========
    btnExtract.addEventListener('click', async ()=>{
      try{
        const files = Array.from(input.files || []);
        if (!files.length) return setStatus("<span class='muted'>Choose at least one file.</span>");
        btnExtract.disabled = true;
        setStatus("Your files are processing, please wait‚Ä¶ ‚è≥");
        logEl.textContent=""; logEl.classList.add('hidden');

        for (const f of files){
          log("-> " + f.name);
          const payload = { imagesDataUrls: [], docText: "" };
          if (f.type === "application/pdf"){
            payload.imagesDataUrls = await pdfToImages(f);
            log("   PDF pages -> " + payload.imagesDataUrls.length + " image(s)");
          } else if (f.type.startsWith("image/")){
            payload.imagesDataUrls = [ await imageToCompressedDataUrl(f) ];
            log("   Image compressed");
          } else if (f.name.toLowerCase().endsWith(".docx")){
            payload.docText = await docxToText(f);
            log("   DOCX text extracted");
          } else {
            log("   Skipped unsupported file.");
            continue;
          }

          const json = await postToWorker(payload);
          sessionRows.push( rowFromJson(json, f.name) );
          log("   ‚úì extracted");

          // free big stuff
          payload.imagesDataUrls = null; payload.docText = null;
        }

        refreshPreview();
        setStatus("Your Excel data is ready. You can <b>Review</b> or <b>Download</b> it.");
        // keep the page alive for appending more files if the user wants
      } catch(err){
        console.error(err);
        log("Error: " + err.message);
        setStatus("<span style='color:#ffaaaa'>Error: " + (err.message||err) + "</span>");
      } finally{
        btnExtract.disabled = false;
      }
    });

    btnPreview.addEventListener('click', ()=>{
      if (!sessionRows.length) return;
      refreshPreview();
      previewWrap.scrollIntoView({behavior:"smooth", block:"center"});
    });

    btnDownload.addEventListener('click', ()=>{
      if (!sessionRows.length) return;
      downloadExcel(sessionRows);
    });

    btnReset.addEventListener('click', ()=>{
      sessionRows.length = 0;
      setRowCount(0);
      btnPreview.disabled = true; btnDownload.disabled = true;
      previewWrap.classList.add('hidden');
      input.value = "";
      setStatus("<span class='muted'>Session cleared. You can upload new files.</span>");
      logEl.textContent=""; logEl.classList.add('hidden');
    });
  </script>
</body>
</html>
